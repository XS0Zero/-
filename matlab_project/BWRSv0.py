import numpy as np

def BWR(P,T):
    z = np.mat([0.952, 0, 0.048, 0, 0, 0, 0, 0, 0, 0])
    M = np.mat([16, 30, 44, 58, 58, 72, 72, 44, 28, 34])
    k = np.mat([
        [0, 0, 0.035, 0.05, 0.048, 0.045, 0.05, 0.05, 0.05, 0.05],
        [0, 0, 0, 0.025, 0.07, 0.1, 0.11, 0.12, 0.134, 0.134],
        [0.035, 0, 0, 0.05, 0.045, 0.04, 0.036, 0.034, 0.028, 0.028],
        [0.05, 0.025, 0.05, 0, 0.01, 0.023, 0.0275, 0.031, 0.036, 0.041],
        [0.048, 0.07, 0.045, 0.01, 0, 0.0031, 0.004, 0.0045, 0.005, 0.006],
        [0.045, 0.1, 0.04, 0.023, 0.0031, 0, 0.003, 0.0035, 0.004, 0.0045],
        [0.05, 0.11, 0.036, 0.0275, 0.004, 0.003, 0, 0, 0.0008, 0.001],
        [0.05, 0.12, 0.034, 0.031, 0.0045, 0.0035, 0, 0, 0.0008, 0.001],
        [0.05, 0.134, 0.028, 0.036, 0.005, 0.004, 0.0008, 0.0008, 0, 0],
        [0.05, 0.134, 0.028, 0.041, 0.006, 0.0045, 0.001, 0.001, 0, 0]
    ])
    Tt = np.mat([-82.46, 32.23, 96.739, 134.98, 152.03, 187.22, 196.34, 30.94, -147, 100.24])
    Tc = 273.15 + Tt
    denc = np.mat([10.05, 6.757, 4.999, 3.801, 3.921, 3.247, 3.215, 10.683, 11.099, 10.526])
    w = np.mat([0.013, 0.1018, 0.157, 0.183, 0.197, 0.226, 0.252, 0.21, 0.035, 0.105])
    Aj = np.mat([0.44369, 1.28438, 0.356306, 0.544979, 0.528629, 0.484011, 0.0705233, 0.504087, 0.0307452, 0.0732828, 0.00645])
    Bj = np.mat([0.115449, -0.920731, 1.70871, -0.270896, 0.349261, 0.75413, -0.044448, 1.32245, 0.179433, 0.463492, -0.022143])


    # 给定的参数
    Pd = P * 1e3  # 压力 P 转换为 kPa
    R = 8.3143  # 气体常数
    Ro = np.zeros(2)  # 初始密度
    Ro[1] = Pd / R / T  # 根据状态方程计算密度

    # 计算中间变量
    B0i = (Aj[0] + Bj[0] * w) / denc
    A0i = (Aj[1] + Bj[1] * w) / denc * R * Tc
    C0i = (Aj[2] + Bj[2] * w) / denc * R * Tc ** 3
    gamai = (Aj[3] + Bj[3] * w) / denc ** 2
    bi = (Aj[4] + Bj[4] * w) / denc ** 2
    ai = (Aj[5] + Bj[5] * w) / denc ** 2 * Tc * R
    alphai = (Aj[6] + Bj[6] * w) / denc ** 3
    ci = (Aj[7] + Bj[7] * w) / denc ** 2 * Tc ** 3 * R
    D0i = (Aj[8] + Bj[8] * w) / denc ** 2 * Tc ** 4 * R
    di = (Aj[9] + Bj[9] * w) / denc ** 2 * Tc ** 2 * R
    E0i = (Aj[10] + Bj[10] * w * np.exp(-3.8 * w)) / denc * Tc ** 5 * R

    # 计算综合变量
    A0 = np.sum(np.sum((z * z.T) * ((A0i ** 0.5) * (A0i ** 0.5).T) * (1 - k)))
    B0 = np.sum(z * B0i)
    C0 = np.sum(np.sum((z * z.T) * ((C0i ** 0.5) * (C0i ** 0.5).T) * (1 - k) ** 3))
    D0 = np.sum(np.sum((z * z.T) * ((D0i ** 0.5) * (D0i ** 0.5).T) * (1 - k) ** 4))
    E0 = np.sum(np.sum((z * z.T) * ((E0i ** 0.5) * (E0i ** 0.5).T) * (1 - k) ** 5))

    a = np.sum(z * ai ** (1 / 3)) ** 3
    b = np.sum(z * bi ** (1 / 3)) ** 3
    c = np.sum(z * ci ** (1 / 3)) ** 3
    d = np.sum(z * di ** (1 / 3)) ** 3
    gama = np.sum(z * gamai ** (1 / 2)) ** 2
    alpha = np.sum(z * alphai ** (1 / 3)) ** 3

    kk = 1

    while abs(Ro[kk + 1] - Ro[kk]) > 1e-6:
        kk = kk + 1
        if kk == 1:
            FRo = np.zeros(2)
        FRo[kk - 1:kk] = Ro[kk - 1:kk] * R * T + (B0 * R * T - A0 - C0 / T ** 2 + D0 / T ** 3 - E0 / T ** 4) * Ro[
                                                                                                               kk - 1:kk] ** 2 + \
                         (b * R * T - a - d / T) * Ro[kk - 1:kk] ** 3 + alpha * (a + d / T) * Ro[kk - 1:kk] ** 6 + \
                         c * Ro[kk - 1:kk] ** 3 / T ** 2 * (1 + gama * Ro[kk - 1:kk] ** 2) * np.exp(
            -gama * Ro[kk - 1:kk] ** 2) - Pd
        Ro[kk + 1] = (Ro[kk - 1] * FRo[kk] - Ro[kk] * FRo[kk - 1]) / (FRo[kk] - FRo[kk - 1])

    z1 = 1 + ((B0 * R * T - A0 - C0 / T ** 2 + D0 / T ** 3 - E0 / T ** 4) * Ro[-1] ** 2 +
              (b * R * T - a - d / T) * Ro[-1] ** 3 +
              alpha * (a + d / T) * Ro[-1] ** 6 +
              c * Ro[-1] ** 3 / T ** 2 * (1 + gama * Ro[-1] ** 2) * np.exp(-gama * Ro[-1] ** 2)) / (Ro[-1] * R * T)

    den = Ro[-1]  # kmol/m3
    Z = z1
    M1 = M * z
    denqti = M1 / 29.16
    r = denqti
    return den